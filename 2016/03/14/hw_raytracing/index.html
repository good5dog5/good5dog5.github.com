
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>2016嵌入式系統作業w2 - raytracing效能改進與分析 | 一奔二飛</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Jordan Huang">
    

    
    <meta name="description" content="github repository  
課程網頁

作業(A)目標

以 make PROFILE=1 重新編譯程式碼，並且學習 gprof  
以 gprof 指出效能瓶頸，並且著手改寫檔案 math-toolkit.h 在內的函式實做，充分紀錄效能差異在共筆  
注意: 請勿更動編譯器最佳化選項 -O0 (關閉最佳化)  
檔案 math-toolkit.h 定義的若干數學操作函式很重要，可">
<meta property="og:type" content="article">
<meta property="og:title" content="2016嵌入式系統作業w2 - raytracing效能改進與分析">
<meta property="og:url" content="http://good5dog5.github.io/2016/03/14/hw_raytracing/index.html">
<meta property="og:site_name" content="一奔二飛">
<meta property="og:description" content="github repository  
課程網頁

作業(A)目標

以 make PROFILE=1 重新編譯程式碼，並且學習 gprof  
以 gprof 指出效能瓶頸，並且著手改寫檔案 math-toolkit.h 在內的函式實做，充分紀錄效能差異在共筆  
注意: 請勿更動編譯器最佳化選項 -O0 (關閉最佳化)  
檔案 math-toolkit.h 定義的若干數學操作函式很重要，可">
<meta property="og:image" content="https://i.imgur.com/ZeurMJC.png">
<meta property="og:image" content="https://dl.dropboxusercontent.com/u/31201582/Blogger/2016-03-14-hw_raytracing/flat-profile.png">
<meta property="og:image" content="https://dl.dropboxusercontent.com/u/31201582/Blogger/2016-03-14-hw_raytracing/unrolling.png">
<meta property="og:image" content="https://dl.dropboxusercontent.com/u/31201582/Blogger/2016-03-14-hw_raytracing/inline.png">
<meta property="og:image" content="https://dl.dropboxusercontent.com/u/31201582/Blogger/2016-03-14-hw_raytracing/simd.png">
<meta property="og:image" content="https://i.imgur.com/g1igqDA.png">
<meta property="og:image" content="https://i.imgur.com/3V4tDKd.png">
<meta property="og:image" content="https://i.imgur.com/ba8zoZE.png">
<meta property="og:image" content="https://i.imgur.com/S0ILAtp.png">
<meta property="og:image" content="https://i.imgur.com/fgWnr2I.png">
<meta property="og:image" content="https://i.imgur.com/nD7nUsZ.png">
<meta property="og:image" content="https://i.imgur.com/oPHYDpH.png">
<meta property="og:image" content="https://i.imgur.com/Uqj2YzY.png">
<meta property="og:updated_time" content="2016-06-12T01:22:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2016嵌入式系統作業w2 - raytracing效能改進與分析">
<meta name="twitter:description" content="github repository  
課程網頁

作業(A)目標

以 make PROFILE=1 重新編譯程式碼，並且學習 gprof  
以 gprof 指出效能瓶頸，並且著手改寫檔案 math-toolkit.h 在內的函式實做，充分紀錄效能差異在共筆  
注意: 請勿更動編譯器最佳化選項 -O0 (關閉最佳化)  
檔案 math-toolkit.h 定義的若干數學操作函式很重要，可">
<meta name="twitter:image" content="https://i.imgur.com/ZeurMJC.png">

    
    <link rel="alternative" href="/atom.xml" title="一奔二飛" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <meta name="google-site-verification" content="x99kAHj-gCMS5M9ADRJOZwI_xsHXfgWfUpOcAhEivNk" />
    <meta name="google-site-verification" content="x99kAHj-gCMS5M9ADRJOZwI_xsHXfgWfUpOcAhEivNk" />
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="一奔二飛" title="一奔二飛"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="一奔二飛">一奔二飛</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/14/hw_raytracing/" title="2016嵌入式系統作業w2 - raytracing效能改進與分析" itemprop="url">2016嵌入式系統作業w2 - raytracing效能改進與分析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jordan Huang" target="_blank" itemprop="author">Jordan Huang</a>
		
  <p class="article-time">
    <time datetime="2016-03-14T16:12:12.000Z" itemprop="datePublished"> Published 2016-03-14</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#作業-A"><span class="toc-number">1.</span> <span class="toc-text">作業(A)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#目標"><span class="toc-number">1.1.</span> <span class="toc-text">目標</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gprof-Gun-Profiler"><span class="toc-number">1.2.</span> <span class="toc-text">gprof - Gun Profiler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用-Graphviz-產生函數呼叫關係圖"><span class="toc-number">1.3.</span> <span class="toc-text">利用 Graphviz 產生函數呼叫關係圖</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改-math-toolkit-h"><span class="toc-number">2.</span> <span class="toc-text">修改 math-toolkit.h</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用inline"><span class="toc-number">2.1.</span> <span class="toc-text">利用inline</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用SIMD"><span class="toc-number">2.2.</span> <span class="toc-text">利用SIMD</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AVX-YMM-and-XMM"><span class="toc-number">2.2.1.</span> <span class="toc-text">AVX , YMM  and XMM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改add-vector-to-SIMD"><span class="toc-number">2.2.2.</span> <span class="toc-text">修改add_vector to SIMD</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a></li></ol>
		
		</div>
		
		<ul>
<li><a href="https://github.com/good5dog5/raytracing" target="_blank" rel="external">github repository</a>  </li>
<li><a href="http://wiki.csie.ncku.edu.tw/embedded/2016q1h2" target="_blank" rel="external">課程網頁</a></li>
</ul>
<h2 id="作業-A"><a href="#作業-A" class="headerlink" title="作業(A)"></a>作業(A)</h2><h3 id="目標"><a href="#目標" class="headerlink" title="目標"></a>目標</h3><blockquote>
<ul>
<li>以 <code>make PROFILE=1</code> 重新編譯程式碼，並且學習 <a href="https://sourceware.org/binutils/docs/gprof/" target="_blank" rel="external">gprof</a>  </li>
<li>以 <code>gprof</code> 指出效能瓶頸，並且著手改寫檔案 <code>math-toolkit.h</code> 在內的函式實做，充分紀錄效能差異在共筆  </li>
<li>注意: 請勿更動編譯器最佳化選項 <code>-O0</code> (關閉最佳化)  </li>
<li>檔案 math-toolkit.h 定義的若干數學操作函式很重要，可參考 <a href="http://tomjbward.co.uk/simd-optimized-dot-and-cross/" target="_blank" rel="external">SIMD optimized dot and cross product functions</a> 和 <a href="http://wiki.csie.ncku.edu.tw/embedded/2015q3h1ext" target="_blank" rel="external">2015q3 Homework #1 Ext</a><br>將你的觀察、分析，以及各式效能改善過程，並善用 <code>gnuplot</code> 製圖。</li>
</ul>
</blockquote>
<a id="more"></a>
<h3 id="gprof-Gun-Profiler"><a href="#gprof-Gun-Profiler" class="headerlink" title="gprof - Gun Profiler"></a>gprof - Gun Profiler</h3><hr>
<p>Profiling能讓程式撰寫者了解程式花在各function的時間和function間的呼叫關係，並能有效找出與預期有落差的funciton，<br>改善整體效能。</p>
<p>gprof需要在compile時加入 <code>-pg</code> flag，如此會告知 <code>gcc</code> 在compile時為每個function加入名為mcount ( or  “_mcount”  , or  “__mcount” , depend on compiler and OS.)的函数<br>則每個funciton執行時都會call mcount，而mcount會存有一份calling graph，裡頭紀錄了child function和parent funciton的關係，呼叫時間以及呼叫次數等資訊。</p>
<p>利用<code>make PROFILE=1</code>編譯時：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ifeq ($(strip $(PROFILE)),1)</span><br><span class="line">PROF_FLAGS = -pg</span><br><span class="line">CFLAGS += $(PROF_FLAGS)</span><br><span class="line">LDFLAGS += $(PROF_FLAGS) </span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p><code>$(strip $(PROFILE)), 1)</code>，strip去掉$PROFILE的開頭結尾空字符<br>比較$PROFILE==1?，成立時則將<code>CFLAGS</code>和 <code>LDFLAGS</code> 加入 <code>-pg</code>字串<br>因為在runtime會多執行mcount，故執行時間會比沒有加<code>-pg</code>flag的慢許多。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make PROFILE=1</span><br></pre></td></tr></table></figure>
<p>執行 ./raytracing，得到gmon.out(只能用gprof來讀取)，並把data<br>redirect到<code>analysis.txt</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gprof raytracing gmon.out &gt; analysis.txt</span><br></pre></td></tr></table></figure>
<h3 id="利用-Graphviz-產生函數呼叫關係圖"><a href="#利用-Graphviz-產生函數呼叫關係圖" class="headerlink" title="利用 Graphviz 產生函數呼叫關係圖"></a>利用 <a href="http://www.graphviz.org/" target="_blank" rel="external">Graphviz</a> 產生函數呼叫關係圖</h3><hr>
<blockquote>
<p>Graphviz is open source graph visualization software. Graph visualization is a  way of<br>representing structural information as diagrams of abstract graphs and  networks. It has important<br>applications in networking, bioinformatics,  software  engineering, database and web design,<br>machine learning, and in visual interfaces  for other technical domains.</p>
</blockquote>
<p>參考<a href="https://embedded2016.hackpad.com/2016q1-Homwork2a--QixiAsqbVaf" target="_blank" rel="external">林秉錚的hackpad</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安裝</span></span><br><span class="line">pip install gprof2dot</span><br></pre></td></tr></table></figure>
<ol>
<li>利用<a href="https://github.com/jrfonseca/gprof2dot" target="_blank" rel="external">gprof2dot</a>，將<code>gmon.out</code>轉成<code>graphviz</code> 所用的<code>dot language</code></li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gprof raytracing | gprof2dot</span><br></pre></td></tr></table></figure>
<p>結果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">digraph &#123;</span><br><span class="line">	graph [fontname=Arial, nodesep=0.125, ranksep=0.25];</span><br><span class="line">	node [fontcolor=white, fontname=Arial, height=0, shape=box, style=filled, width=0];</span><br><span class="line">	edge [fontname=Arial];</span><br><span class="line">	1 [color=&quot;#ff0000&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;raytracing\n100.00%\n(0.59%)\n1×&quot;];</span><br><span class="line">	1 -&gt; 3 [arrowsize=&quot;0.97&quot;, color=&quot;#f63d01&quot;, fontcolor=&quot;#f63d01&quot;, fontsize=&quot;10.00&quot;, label=&quot;93.96%\n1048576×&quot;, labeldistance=&quot;3.76&quot;, penwidth=&quot;3.76&quot;];</span><br><span class="line">	1 -&gt; 15 [arrowsize=&quot;0.35&quot;, color=&quot;#0d2379&quot;, fontcolor=&quot;#0d2379&quot;, fontsize=&quot;10.00&quot;, label=&quot;5.15%\n1048576×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	2 [color=&quot;#ff0000&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;main\n100.00%\n(0.00%)&quot;];</span><br><span class="line">	2 -&gt; 1 [arrowsize=&quot;1.00&quot;, color=&quot;#ff0000&quot;, fontcolor=&quot;#ff0000&quot;, fontsize=&quot;10.00&quot;, label=&quot;100.00%\n1×&quot;, labeldistance=&quot;4.00&quot;, penwidth=&quot;4.00&quot;];</span><br><span class="line">	3 [color=&quot;#f63d01&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;ray_color\n93.96%\n(1.48%)\n2403255×&quot;];</span><br><span class="line">	3 -&gt; 3 [arrowsize=&quot;0.97&quot;, color=&quot;#f63d01&quot;, fontcolor=&quot;#f63d01&quot;, fontsize=&quot;10.00&quot;, label=&quot;1354679×&quot;, labeldistance=&quot;3.76&quot;, penwidth=&quot;3.76&quot;];</span><br><span class="line">	3 -&gt; 4 [arrowsize=&quot;0.70&quot;, color=&quot;#0ab50f&quot;, fontcolor=&quot;#0ab50f&quot;, fontsize=&quot;10.00&quot;, label=&quot;49.29%\n4620625×&quot;, labeldistance=&quot;1.97&quot;, penwidth=&quot;1.97&quot;];</span><br><span class="line">	3 -&gt; 6 [arrowsize=&quot;0.42&quot;, color=&quot;#0c6389&quot;, fontcolor=&quot;#0c6389&quot;, fontsize=&quot;10.00&quot;, label=&quot;17.35%\n2110576×&quot;, labeldistance=&quot;0.69&quot;, penwidth=&quot;0.69&quot;];</span><br><span class="line">	3 -&gt; 7 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1e78&quot;, fontcolor=&quot;#0d1e78&quot;, fontsize=&quot;10.00&quot;, label=&quot;4.00%\n2596277×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	3 -&gt; 9 [arrowsize=&quot;0.35&quot;, color=&quot;#0d0f73&quot;, fontcolor=&quot;#0d0f73&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.51%\n686738×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	3 -&gt; 11 [arrowsize=&quot;0.35&quot;, color=&quot;#0d3c80&quot;, fontcolor=&quot;#0d3c80&quot;, fontsize=&quot;10.00&quot;, label=&quot;10.22%\n2110576×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	3 -&gt; 12 [arrowsize=&quot;0.35&quot;, color=&quot;#0d0e73&quot;, fontcolor=&quot;#0d0e73&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.40%\n2483196×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	3 -&gt; 13 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1074&quot;, fontcolor=&quot;#0d1074&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.72%\n3169934×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	3 -&gt; 16 [arrowsize=&quot;0.35&quot;, color=&quot;#0d2279&quot;, fontcolor=&quot;#0d2279&quot;, fontsize=&quot;10.00&quot;, label=&quot;4.90%\n3724794×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	3 -&gt; 17 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1375&quot;, fontcolor=&quot;#0d1375&quot;, fontsize=&quot;10.00&quot;, label=&quot;1.40%\n1241598×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	3 -&gt; 19 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1375&quot;, fontcolor=&quot;#0d1375&quot;, fontsize=&quot;10.00&quot;, label=&quot;1.48%\n2520791×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	3 -&gt; 20 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1074&quot;, fontcolor=&quot;#0d1074&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.85%\n1241598×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	3 -&gt; 21 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1074&quot;, fontcolor=&quot;#0d1074&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.89%\n1204003×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	4 [color=&quot;#0ab50f&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;ray_hit_object\n49.29%\n(2.67%)\n4620625×&quot;];</span><br><span class="line">	4 -&gt; 5 [arrowsize=&quot;0.52&quot;, color=&quot;#0c9789&quot;, fontcolor=&quot;#0c9789&quot;, fontsize=&quot;10.00&quot;, label=&quot;27.38%\n13861875×&quot;, labeldistance=&quot;1.10&quot;, penwidth=&quot;1.10&quot;];</span><br><span class="line">	4 -&gt; 8 [arrowsize=&quot;0.38&quot;, color=&quot;#0c5486&quot;, fontcolor=&quot;#0c5486&quot;, fontsize=&quot;10.00&quot;, label=&quot;14.73%\n13861875×&quot;, labeldistance=&quot;0.59&quot;, penwidth=&quot;0.59&quot;];</span><br><span class="line">	4 -&gt; 9 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1b77&quot;, fontcolor=&quot;#0d1b77&quot;, fontsize=&quot;10.00&quot;, label=&quot;3.46%\n4620625×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	4 -&gt; 13 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1174&quot;, fontcolor=&quot;#0d1174&quot;, fontsize=&quot;10.00&quot;, label=&quot;1.05%\n4620625×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	5 [color=&quot;#0c9789&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;rayRectangularIntersection\n27.38%\n(10.09%)\n13861875×&quot;];</span><br><span class="line">	5 -&gt; 9 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1074&quot;, fontcolor=&quot;#0d1074&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.89%\n1187811×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	5 -&gt; 10 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1f78&quot;, fontcolor=&quot;#0d1f78&quot;, fontsize=&quot;10.00&quot;, label=&quot;4.27%\n28627374×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	5 -&gt; 12 [arrowsize=&quot;0.35&quot;, color=&quot;#0d277a&quot;, fontcolor=&quot;#0d277a&quot;, fontsize=&quot;10.00&quot;, label=&quot;5.93%\n36717187×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	5 -&gt; 13 [arrowsize=&quot;0.35&quot;, color=&quot;#0d0e73&quot;, fontcolor=&quot;#0d0e73&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.27%\n1187811×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	5 -&gt; 14 [arrowsize=&quot;0.35&quot;, color=&quot;#0d277a&quot;, fontcolor=&quot;#0d277a&quot;, fontsize=&quot;10.00&quot;, label=&quot;5.93%\n17821807×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	6 [color=&quot;#0c6389&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;compute_specular_diffuse\n17.35%\n(3.86%)\n2110576×&quot;];</span><br><span class="line">	6 -&gt; 7 [arrowsize=&quot;0.35&quot;, color=&quot;#0d397f&quot;, fontcolor=&quot;#0d397f&quot;, fontsize=&quot;10.00&quot;, label=&quot;9.75%\n6331728×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	6 -&gt; 10 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1375&quot;, fontcolor=&quot;#0d1375&quot;, fontsize=&quot;10.00&quot;, label=&quot;1.49%\n9964085×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	6 -&gt; 12 [arrowsize=&quot;0.35&quot;, color=&quot;#0d0e73&quot;, fontcolor=&quot;#0d0e73&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.34%\n2110576×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	6 -&gt; 13 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1575&quot;, fontcolor=&quot;#0d1575&quot;, fontsize=&quot;10.00&quot;, label=&quot;1.91%\n8442304×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	7 [color=&quot;#0c5d88&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;normalize\n16.32%\n(16.32%)\n10598450×&quot;];</span><br><span class="line">	8 [color=&quot;#0c5486&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;raySphereIntersection\n14.73%\n(6.53%)\n13861875×&quot;];</span><br><span class="line">	8 -&gt; 7 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1174&quot;, fontcolor=&quot;#0d1174&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.96%\n621866×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	8 -&gt; 9 [arrowsize=&quot;0.35&quot;, color=&quot;#0d0f73&quot;, fontcolor=&quot;#0d0f73&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.47%\n621866×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	8 -&gt; 10 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1f78&quot;, fontcolor=&quot;#0d1f78&quot;, fontsize=&quot;10.00&quot;, label=&quot;4.23%\n28345616×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	8 -&gt; 12 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1776&quot;, fontcolor=&quot;#0d1776&quot;, fontsize=&quot;10.00&quot;, label=&quot;2.34%\n14483741×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	8 -&gt; 13 [arrowsize=&quot;0.35&quot;, color=&quot;#0d0e73&quot;, fontcolor=&quot;#0d0e73&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.21%\n933714×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	9 [color=&quot;#0d4c84&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;add_vector\n13.35%\n(13.35%)\n17836094×&quot;];</span><br><span class="line">	10 [color=&quot;#0d3d80&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;dot_product\n10.39%\n(10.39%)\n69646433×&quot;];</span><br><span class="line">	11 [color=&quot;#0d3c80&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;localColor\n10.22%\n(2.37%)\n2110576×&quot;];</span><br><span class="line">	11 -&gt; 9 [arrowsize=&quot;0.35&quot;, color=&quot;#0d2179&quot;, fontcolor=&quot;#0d2179&quot;, fontsize=&quot;10.00&quot;, label=&quot;4.74%\n6331728×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	11 -&gt; 13 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1575&quot;, fontcolor=&quot;#0d1575&quot;, fontsize=&quot;10.00&quot;, label=&quot;1.91%\n8442304×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	11 -&gt; 18 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1274&quot;, fontcolor=&quot;#0d1274&quot;, fontsize=&quot;10.00&quot;, label=&quot;1.19%\n4221152×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	12 [color=&quot;#0d377f&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;subtract_vector\n9.20%\n(9.20%)\n56956357×&quot;];</span><br><span class="line">	13 [color=&quot;#0d2c7c&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;multiply_vector\n7.12%\n(7.12%)\n31410180×&quot;];</span><br><span class="line">	14 [color=&quot;#0d277a&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;cross_product\n5.93%\n(5.93%)\n17821809×&quot;];</span><br><span class="line">	15 [color=&quot;#0d2379&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;rayConstruction\n5.15%\n(0.30%)\n1048576×&quot;];</span><br><span class="line">	15 -&gt; 7 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1375&quot;, fontcolor=&quot;#0d1375&quot;, fontsize=&quot;10.00&quot;, label=&quot;1.61%\n1048576×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	15 -&gt; 9 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1776&quot;, fontcolor=&quot;#0d1776&quot;, fontsize=&quot;10.00&quot;, label=&quot;2.36%\n3145728×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	15 -&gt; 12 [arrowsize=&quot;0.35&quot;, color=&quot;#0d0d73&quot;, fontcolor=&quot;#0d0d73&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.17%\n1048576×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	15 -&gt; 13 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1074&quot;, fontcolor=&quot;#0d1074&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.71%\n3145728×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	16 [color=&quot;#0d2379&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;length\n5.04%\n(5.04%)\n3838091×&quot;];</span><br><span class="line">	17 [color=&quot;#0d1375&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;reflection\n1.40%\n(0.00%)\n1241598×&quot;];</span><br><span class="line">	17 -&gt; 9 [arrowsize=&quot;0.35&quot;, color=&quot;#0d1174&quot;, fontcolor=&quot;#0d1174&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.93%\n1241598×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	17 -&gt; 10 [arrowsize=&quot;0.35&quot;, color=&quot;#0d0e73&quot;, fontcolor=&quot;#0d0e73&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.19%\n1241598×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	17 -&gt; 13 [arrowsize=&quot;0.35&quot;, color=&quot;#0d0e73&quot;, fontcolor=&quot;#0d0e73&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.28%\n1241598×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	18 [color=&quot;#0d1274&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;multiply_vectors\n1.19%\n(1.19%)\n4221152×&quot;];</span><br><span class="line">	19 [color=&quot;#0d1375&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;idx_stack_top\n1.48%\n(1.19%)\n2520791×&quot;];</span><br><span class="line">	20 [color=&quot;#0d1074&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;refraction\n0.85%\n(0.59%)\n1241598×&quot;];</span><br><span class="line">	20 -&gt; 10 [arrowsize=&quot;0.35&quot;, color=&quot;#0d0e73&quot;, fontcolor=&quot;#0d0e73&quot;, fontsize=&quot;10.00&quot;, label=&quot;0.19%\n1241598×&quot;, labeldistance=&quot;0.50&quot;, penwidth=&quot;0.50&quot;];</span><br><span class="line">	21 [color=&quot;#0d1074&quot;, fontcolor=&quot;#ffffff&quot;, fontsize=&quot;10.00&quot;, label=&quot;idx_stack_push\n0.89%\n(0.89%)\n1204003×&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.直接轉成圖片</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gprof raytracing | gprof2dot | dot -Tpng -o codemap.png</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/ZeurMJC.png" alt="效果"></p>
<p><code>analysis.txt</code> 中分為幾個部份</p>
<ol>
<li><a href="https://sourceware.org/binutils/docs/gprof/Flat-Profile.html" target="_blank" rel="external">Flat Profile</a><br><strong>The flat profile shows the total amount of time your program spent executing each function.</strong></li>
</ol>
<p><img src="https://dl.dropboxusercontent.com/u/31201582/Blogger/2016-03-14-hw_raytracing/flat-profile.png" alt="raytracing的gprfo圖"><br>各column分別代表</p>
<ul>
<li><code>time</code><br>  function執行時間的百分比，加總起來應為100%。</li>
<li><code>cumulative seconds</code><br>  此function的執行時間(second)，加上此funciton之前functions執行時間的總和。</li>
<li><code>self seconds</code><br>  此function獨自執行的時間，flat profile以此column為第一順位排序。</li>
<li><code>calls</code><br>  此function被called的次數，如果被called的次數沒辦法被統計或<br>  This is the total number of times the function was called. If the function was never called, or the number of times it was called cannot be determined (probably because the function was not compiled with profiling enabled), the calls field is blank.</li>
<li><code>self ms/call</code><br>  代表 <strong>average number of milliseconds spent in this function per call</strong>， 若沒被profiled則為空。</li>
<li><code>total ms/call</code><br>  This represents the average number of milliseconds spent in this function and its descendants per call, if this function is profiled. Otherwise, this field is blank for this function. This is the only field in the flat profile that uses call graph analysis.</li>
<li><code>name</code><br>  funtion name.</li>
</ul>
<p>由flat profile中可發現，主要的效能瓶頸在  </p>
<table>
<thead>
<tr>
<th>function name</th>
<th style="text-align:center">calls</th>
<th style="text-align:right">second</th>
</tr>
</thead>
<tbody>
<tr>
<td>dot_product</td>
<td style="text-align:center">69646433</td>
<td style="text-align:right">1.19</td>
</tr>
<tr>
<td>subtract_vector</td>
<td style="text-align:center">56956357</td>
<td style="text-align:right">0.58</td>
</tr>
<tr>
<td>multiply_vector</td>
<td style="text-align:center">31410180</td>
<td style="text-align:right">0.34</td>
</tr>
</tbody>
</table>
<h2 id="修改-math-toolkit-h"><a href="#修改-math-toolkit-h" class="headerlink" title="修改 math-toolkit.h"></a>修改 math-toolkit.h</h2><p>可以發現 <code>add_vector</code>, <code>subtract_vector</code>, <code>multiply_vectors</code>, <code>multiply_vector</code>,<br><code>dot_product</code>中的forloop都只有3個iteration，因為本作業強制使用<code>-O0</code><br>flag（禁用最佳化），所以編譯器不會幫忙做<a href="https://www.wikiwand.com/en/Loop_unrolling" target="_blank" rel="external">loop unrolling</a>。</p>
<ul>
<li><p>loop unrolling的好處</p>
<ol>
<li>減少index arthimetic operation，和end of loop test。</li>
<li>最小化branch penalty。</li>
<li>能讓instruction更能平行執行。</li>
</ol>
</li>
<li><p>loop unrolling的壞處</p>
<ol>
<li>code size變大。</li>
</ol>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">void</span> <span class="title">add_vector</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">const</span> <span class="keyword">double</span> *b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">        out[i] = a[i] + b[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">void</span> <span class="title">subtract_vector</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">const</span> <span class="keyword">double</span> *b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">        out[i] = a[i] - b[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">void</span> <span class="title">multiply_vectors</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">const</span> <span class="keyword">double</span> *b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">        out[i] = a[i] * b[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">void</span> <span class="title">multiply_vector</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">double</span> b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">        out[i] = a[i] * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">double</span> <span class="title">dot_product</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *v1, <span class="keyword">const</span> <span class="keyword">double</span> *v2)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> dp = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">        dp += v1[i] * v2[i];</span><br><span class="line">    <span class="keyword">return</span> dp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>做完 loop unrolling後</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">void</span> <span class="title">add_vector</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">const</span> <span class="keyword">double</span> *b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">        out[<span class="number">0</span>] = a[<span class="number">0</span>] + b[<span class="number">0</span>];</span><br><span class="line">        out[<span class="number">1</span>] = a[<span class="number">1</span>] + b[<span class="number">1</span>];</span><br><span class="line">        out[<span class="number">2</span>] = a[<span class="number">2</span>] + b[<span class="number">2</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">void</span> <span class="title">subtract_vector</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">const</span> <span class="keyword">double</span> *b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">        out[<span class="number">0</span>] = a[<span class="number">0</span>] - b[<span class="number">0</span>];</span><br><span class="line">        out[<span class="number">1</span>] = a[<span class="number">1</span>] - b[<span class="number">1</span>];</span><br><span class="line">        out[<span class="number">2</span>] = a[<span class="number">2</span>] - b[<span class="number">2</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">void</span> <span class="title">multiply_vectors</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">const</span> <span class="keyword">double</span> *b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">        out[<span class="number">0</span>] = a[<span class="number">0</span>] * b[<span class="number">0</span>];</span><br><span class="line">        out[<span class="number">1</span>] = a[<span class="number">1</span>] * b[<span class="number">1</span>];</span><br><span class="line">        out[<span class="number">2</span>] = a[<span class="number">2</span>] * b[<span class="number">2</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">void</span> <span class="title">multiply_vector</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">double</span> b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">        out[<span class="number">0</span>] = a[<span class="number">0</span>] * b;</span><br><span class="line">        out[<span class="number">1</span>] = a[<span class="number">1</span>] * b;</span><br><span class="line">        out[<span class="number">2</span>] = a[<span class="number">2</span>] * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">void</span> <span class="title">cross_product</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *v1, <span class="keyword">const</span> <span class="keyword">double</span> *v2, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    out[<span class="number">0</span>] = v1[<span class="number">1</span>] * v2[<span class="number">2</span>] - v1[<span class="number">2</span>] * v2[<span class="number">1</span>];</span><br><span class="line">    out[<span class="number">1</span>] = v1[<span class="number">2</span>] * v2[<span class="number">0</span>] - v1[<span class="number">0</span>] * v2[<span class="number">2</span>];</span><br><span class="line">    out[<span class="number">2</span>] = v1[<span class="number">0</span>] * v2[<span class="number">1</span>] - v1[<span class="number">1</span>] * v2[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">double</span> <span class="title">dot_product</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *v1, <span class="keyword">const</span> <span class="keyword">double</span> *v2)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> dp = <span class="number">0.0</span>;</span><br><span class="line">    dp += v1[<span class="number">0</span>] * v2[<span class="number">0</span>];</span><br><span class="line">    dp += v1[<span class="number">1</span>] * v2[<span class="number">1</span>];</span><br><span class="line">    dp += v1[<span class="number">2</span>] * v2[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">return</span> dp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整體執行時間快了<code>1.1 second</code><br><img src="https://dl.dropboxusercontent.com/u/31201582/Blogger/2016-03-14-hw_raytracing/unrolling.png" alt="performance比較"></p>
<h3 id="利用inline"><a href="#利用inline" class="headerlink" title="利用inline"></a>利用inline</h3><p>參考<a href="https://embedded2016.hackpad.com/ep/pad/static/xBRCF9BsC50" target="_blank" rel="external">課程提示</a></p>
<p>根據<a href="https://gcc.gnu.org/onlinedocs/gcc/Inline.html" target="_blank" rel="external">GCC manual</a></p>
<blockquote>
<p>GCC does not inline any functions when not optimizing unless you specify the ‘always_inline’<br>attribute for the function, like this:<br>/ Prototype.<br>inline void foo (const char) attribute((always_inline));</p>
<p>The remainder of this section is specific to GNU C90 inlining.</p>
</blockquote>
<p>因為關閉最佳化，所以function宣告為inline並不會有作用，但為了測試inline<br>對效能的影響，在Makefile中的<code>CFLAGS</code>加上 <code>-D__forceinline=&quot;__attribute__((always_inline))&quot;</code><br>並把原本須告為static inline的functions後接加上 <code>__forceinline</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __<span class="function">forceinline</span><br><span class="line"><span class="keyword">void</span> <span class="title">normalize</span><span class="params">(<span class="keyword">double</span> *v)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __forceinline</span><br><span class="line"><span class="keyword">double</span> <span class="title">length</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *v)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __forceinline</span><br><span class="line"><span class="keyword">void</span> <span class="title">add_vector</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">const</span> <span class="keyword">double</span> *b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __forceinline</span><br><span class="line"><span class="keyword">void</span> <span class="title">subtract_vector</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">const</span> <span class="keyword">double</span> *b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __forceinline</span><br><span class="line"><span class="keyword">void</span> <span class="title">multiply_vectors</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">const</span> <span class="keyword">double</span> *b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __forceinline</span><br><span class="line"><span class="keyword">void</span> <span class="title">multiply_vector</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">double</span> b, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __forceinline</span><br><span class="line"><span class="keyword">void</span> <span class="title">cross_product</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *v1, <span class="keyword">const</span> <span class="keyword">double</span> *v2, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __forceinline</span><br><span class="line"><span class="keyword">double</span> <span class="title">dot_product</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *v1, <span class="keyword">const</span> <span class="keyword">double</span> *v2)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __forceinline</span><br><span class="line"><span class="keyword">void</span> <span class="title">scalar_triple_product</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *u, <span class="keyword">const</span> <span class="keyword">double</span> *v, <span class="keyword">const</span> <span class="keyword">double</span> *w, <span class="keyword">double</span> *out)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __forceinline</span><br><span class="line"><span class="keyword">double</span> <span class="title">scalar_triple</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *u, <span class="keyword">const</span> <span class="keyword">double</span> *v, <span class="keyword">const</span> <span class="keyword">double</span> *w)</span></span></span><br></pre></td></tr></table></figure>
<p>GCC:</p>
<blockquote>
<p>By declaring a function inline, you can direct GCC to make calls to that function faster. One way<br>GCC can achieve this is to integrate that function’s code into the code for its callers. This<br>makes execution faster by eliminating the function-call overhead; in addition, if any of the<br>actual argument values are constant, their known values may permit simplifications at compile time<br>so that not all of the inline function’s code needs to be included. The effect on code size is<br>less predictable; object code may be larger or smaller with function inlining, depending on the<br>particular case.</p>
</blockquote>
<p>force inline + loop unrolling效能比較圖,可以看到比原本快了<code>3.9 second</code></p>
<p><img src="https://dl.dropboxusercontent.com/u/31201582/Blogger/2016-03-14-hw_raytracing/inline.png" alt="performance"></p>
<h3 id="利用SIMD"><a href="#利用SIMD" class="headerlink" title="利用SIMD"></a>利用SIMD</h3><hr>
<p><img src="https://dl.dropboxusercontent.com/u/31201582/Blogger/2016-03-14-hw_raytracing/simd.png" alt="simd"><br><img src="https://i.imgur.com/g1igqDA.png" alt="simd2"></p>
<p>SIMD是<strong>Single Instruction/Multiple Data</strong>的縮寫，相較於原本每個指令只處理單一data(SISD or Scalar operation)，SIMD能夠在單一指令中處理多個data。<br><img src="https://i.imgur.com/3V4tDKd.png" alt="simd_example"></p>
<p>但SIMD只能處理特定的<strong>predefined processing pattern</strong>，例如以下情況是SIMD無法處理的。<br><img src="https://i.imgur.com/ba8zoZE.png" alt="situation simd can&#39;t handle"></p>
<p>根據<a href="https://software.intel.com/sites/landingpage/IntrinsicsGuide/#" target="_blank" rel="external">Intel intrinstic guide</a>列出的intrinstic instruction中屬於SIMD指令集的有<br><img src="https://i.imgur.com/S0ILAtp.png" alt="SIMD"></p>
<p>查看 <code>/proc/cpuinfo</code>，發現本機cpu為<code>i5-3320M</code> 支援<code>sse4.1</code> <code>sse4.2</code>, <code>avx</code>等SIMD指令集架構，因<code>avx</code>是基於sse的延伸，且具有<strong>256 bit register</strong>，故用<code>avx</code>來作SIMD加速。<br><img src="https://i.imgur.com/fgWnr2I.png" alt="cpuinfo"></p>
<h4 id="AVX-YMM-and-XMM"><a href="#AVX-YMM-and-XMM" class="headerlink" title="AVX , YMM  and XMM"></a>AVX , YMM  and XMM</h4><p>XMM是舊有SEE指令集的暫存器，只有128 bits，AVX中則有16個256 bits AVX暫存器，和一個control/status register, MXCSR。<br><img src="https://i.imgur.com/nD7nUsZ.png" alt="YMM vs XMM"><br><img src="https://i.imgur.com/oPHYDpH.png" alt="Data type"></p>
<h4 id="修改add-vector-to-SIMD"><a href="#修改add-vector-to-SIMD" class="headerlink" title="修改add_vector to SIMD"></a>修改add_vector to SIMD</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span>  <span class="keyword">void</span> <span class="title">add_vector</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> *a, <span class="keyword">const</span> <span class="keyword">double</span> *b, <span class="keyword">double</span> *out)</span> __forceinline</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">//SIMD version</span></span><br><span class="line">    __m256d v1     = _mm256_set_pd(a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], <span class="number">0.0</span>);</span><br><span class="line">    __m256d v2     = _mm256_set_pd(b[<span class="number">0</span>], b[<span class="number">1</span>], b[<span class="number">2</span>], <span class="number">0.0</span>);</span><br><span class="line">    __m256d result = _mm256_add_pd(v1, v2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> tmp[<span class="number">4</span>];</span><br><span class="line">    _mm256_store_pd(tmp, result);</span><br><span class="line"></span><br><span class="line">    out[<span class="number">0</span>] = tmp[<span class="number">3</span>];</span><br><span class="line">    out[<span class="number">1</span>] = tmp[<span class="number">2</span>];</span><br><span class="line">    out[<span class="number">2</span>] = tmp[<span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Original</span></span><br><span class="line">    <span class="comment">// out[0] = a[0] + b[0];</span></span><br><span class="line">    <span class="comment">// out[1] = a[1] + b[1];</span></span><br><span class="line">    <span class="comment">// out[2] = a[2] + b[2];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/Uqj2YzY.png" alt="gprof 效能"><br>可以看到時間不降反升，從<code>0.10</code> -&gt; <code>0.54</code></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>SIMD<br><a href="https://embedded2016.hackpad.com/2016-Homework-2-A-Od4A8UUBgpF#:h=gprof,-perf,-graphviz-and-gpro" target="_blank" rel="external">evanjack2002 / 開發紀錄(A)</a><br><a href="http://fastcpp.blogspot.tw/2011/04/vector-cross-product-using-sse-code.html" target="_blank" rel="external">FastC++: Coding Cpp Efficiently</a><br><a href="https://software.intel.com/en-us/articles/introduction-to-intel-advanced-vector-extensions" target="_blank" rel="external">Introduction to Intel® Advanced Vector Extensions</a><br><a href="https://www.kernel.org/pub/linux/kernel/people/geoff/cell/ps3-linux-docs/CellProgrammingTutorial/BasicsOfSIMDProgramming.html" target="_blank" rel="external">Basic of SIMD Programming</a><br><a href="https://www.wikiwand.com/zh-tw/SSE" target="_blank" rel="external">Wiki about SSE/AVX</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Homework/">Homework</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/C/">C</a><a href="/tags/gdb/">gdb</a><a href="/tags/embedded-system/">embedded system</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/03/19/urxvt-chinese-word-birck/" title="解決urxvt 中文字方塊問題">
  <span>
  解決urxvt 中文字方塊問題</span>
</a>
</div>


<div class="next">
<a href="/2016/03/08/phonebook/"  title="嵌入式系統作業 - Phonebook效能改進與分析">
 <span>嵌入式系統作業 - Phonebook效能改進與分析
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#作業-A"><span class="toc-number">1.</span> <span class="toc-text">作業(A)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#目標"><span class="toc-number">1.1.</span> <span class="toc-text">目標</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gprof-Gun-Profiler"><span class="toc-number">1.2.</span> <span class="toc-text">gprof - Gun Profiler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用-Graphviz-產生函數呼叫關係圖"><span class="toc-number">1.3.</span> <span class="toc-text">利用 Graphviz 產生函數呼叫關係圖</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改-math-toolkit-h"><span class="toc-number">2.</span> <span class="toc-text">修改 math-toolkit.h</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用inline"><span class="toc-number">2.1.</span> <span class="toc-text">利用inline</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用SIMD"><span class="toc-number">2.2.</span> <span class="toc-text">利用SIMD</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AVX-YMM-and-XMM"><span class="toc-number">2.2.1.</span> <span class="toc-text">AVX , YMM  and XMM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改add-vector-to-SIMD"><span class="toc-number">2.2.2.</span> <span class="toc-text">修改add_vector to SIMD</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/good5dog5" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:good5dog5@gmail.com## e.g. imjark@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="good5dog5" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Blog/" title="Blog">Blog<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/C/" title="C">C<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/CLI/" title="CLI">CLI<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Homework/" title="Homework">Homework<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Job/" title="Job">Job<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Note/" title="Note">Note<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Tools/" title="Tools">Tools<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Work/" title="Work">Work<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/daily/" title="daily">daily<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Note/" title="Note">Note<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/embedded-system/" title="embedded system">embedded system<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/c/" title="c">c<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C">C<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/note/" title="note">note<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/CLI/" title="CLI">CLI<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/urxvt/" title="urxvt">urxvt<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/config/" title="config">config<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Preprocessor/" title="Preprocessor">Preprocessor<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Resume/" title="Resume">Resume<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Job/" title="Job">Job<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/vim/" title="vim">vim<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Blog/" title="Blog">Blog<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/i3-wm/" title="i3 wm">i3 wm<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/gdb/" title="gdb">gdb<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Tmux/" title="Tmux">Tmux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/daily/" title="daily">daily<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/fixed/" title="fixed">fixed<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/GDB/" title="GDB">GDB<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="Jordan Huang">Jordan Huang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'good5dog5';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
