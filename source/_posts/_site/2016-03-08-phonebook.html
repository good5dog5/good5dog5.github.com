<p><a href="https://github.com/good5dog5/phonebook"><strong>github repository</strong></a></p>

<p>參考<a href="http://wiki.csie.ncku.edu.tw/embedded/2016q1h1">課程網頁</a>的作業要求：</p>

<blockquote>
  <ul>
    <li>在 GitHub 上 fork phonebook，然後適度修改 <code class="highlighter-rouge">phonebook_opt.c</code>和 <code class="highlighter-rouge">phonebook_opt.h</code>兩個檔案，使得這兩者執行時期的 cache miss 降低。請用 perf 驗證，而且改進的過程中，不能有功能方面的減損。</li>
    <li><code class="highlighter-rouge">phonebook_orig.[ch]</code> 不需要修改，我們關注的是 <code class="highlighter-rouge">phonebook_opt.[ch]</code>，當然要修改 <code class="highlighter-rouge">main.c</code> 也是允許的</li>
    <li><code class="highlighter-rouge">findName()</code> 的時間必須原本的時間更短</li>
    <li><code class="highlighter-rouge">append()</code> 的時間可以比原始版本稍久，但不應該增加太多</li>
    <li>main.c 應該只有一份，不要建立新的 <code class="highlighter-rouge">main()</code>，善用 Makefile 定義對應的 CFLAGS</li>
  </ul>
</blockquote>

<p>先來看看 <code class="highlighter-rouge">phonebook_orig.h</code> 內的entry struct</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">__PHONE_BOOK_ENTRY</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">lastName</span><span class="p">[</span><span class="n">MAX_LAST_NAME_SIZE</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">firstName</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">email</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">phone</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">cell</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">addr1</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">addr2</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">city</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">zip</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">__PHONE_BOOK_ENTRY</span> <span class="o">*</span><span class="n">pNext</span><span class="p">;</span>
<span class="p">}</span> <span class="n">entry</span><span class="p">;</span>
</code></pre>
</div>

<ul>
  <li>用GDB print sizeof(entry)得出size為136 bytes，但entry中member的總size
應該為131 bytes，因為word alignment的關係才湊成136(136%8=0)。</li>
</ul>

<p>接著看 <code class="highlighter-rouge">main.c</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;time.h&gt;
#include &lt;assert.h&gt;
</span>
<span class="cp">#include IMPL      // WTF?
</span>
<span class="cp">#define DICT_FILE "./dictionary/words.txt"
</span></code></pre>
</div>
<p>#include IMPL須連Makefile一起看才能理解#</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nv">SRCS_common</span> <span class="o">=</span> main.c

<span class="nl">phonebook_orig</span><span class="o">:</span> <span class="nf">$(SRCS_common) phonebook_orig.c phonebook_orig.h</span>
	<span class="nv">$(CC)</span> <span class="nv">$(CFLAGS_common)</span> <span class="nv">$(CFLAGS_orig)</span> <span class="se">\</span>
		-DIMPL<span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$@</span><span class="s2">.h</span><span class="se">\"</span><span class="s2">"</span> -o <span class="nv">$@</span> <span class="se">\</span>
		<span class="nv">$(SRCS_common)</span> <span class="nv">$@</span>.c

<span class="nl">phonebook_opt</span><span class="o">:</span> <span class="nf">$(SRCS_common) phonebook_opt.c phonebook_opt.h</span>
	<span class="nv">$(CC)</span> <span class="nv">$(CFLAGS_common)</span> <span class="nv">$(CFLAGS_opt)</span> <span class="se">\</span>
		-DIMPL<span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="nv">$@</span><span class="s2">.h</span><span class="se">\"</span><span class="s2">"</span> -o <span class="nv">$@</span> <span class="se">\</span>
		<span class="nv">$(SRCS_common)</span> <span class="nv">$@</span>.c
</code></pre>
</div>
<p>-DIMPL 會把main.c中的 #include IMPL換成 phonebook_opt.h或 phonebook_orig.h</p>

<h3 id="perf">利用perf尋找程式熱點</h3>
<p><code class="highlighter-rouge">./phonebook_orig &amp; sudo perf top -p $!</code></p>

<h2 id="cache">cache</h2>
<p>因為我們對此次作業cache misses很在意，故要排除系統cache 的影響，
在每次執行之前手動藉由</p>

<p><code class="highlighter-rouge">echo 1 &gt; /proc/sys/vm/drop_caches</code>來釋放cache。
&gt;<code class="highlighter-rouge">Freeing the page cache:</code><br />
&gt;echo 1 &gt; /proc/sys/vm/drop_caches<br />
&gt;<code class="highlighter-rouge">Free dentries and inodes:</code><br />
&gt;echo 2 &gt; /proc/sys/vm/drop_caches<br />
&gt;<code class="highlighter-rouge">Free the page cache, dentries and the inodes:</code><br />
&gt;echo 3 &gt; /proc/sys/vm/drop_caches</p>

<h2 id="optimize">開始optimize!</h2>

<h3 id="entry">1.減少entry的大小</h3>
<hr />

<p>原本的entry耗用136 bytes，但<code class="highlighter-rouge">append()</code>只會用到entry.lastName這個member
故把其他不相干的members都註解掉，比較原本的cache misses和註解掉後的cache misses。</p>

<p>註解前：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Performance counter stats for './phonebook_opt' (100 runs):  

         1,998,548      cache-misses              #   `94.496 % of all cache refs`  ( +-  0.33% )
         2,114,954      cache-references                                              ( +-  0.20% )
       263,123,256      instructions              #    1.40  insns per cycle          ( +-  0.02% )
       187,765,109      cycles                                                        ( +-  0.68% )

       0.072710909 seconds time elapsed                                               ( +-  0.68% )
</code></pre>
</div>

<p>註解後</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">__PHONE_BOOK_ENTRY</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">lastName</span><span class="p">[</span><span class="n">MAX_LAST_NAME_SIZE</span><span class="p">];</span>
    <span class="c1">// char firstName[16];
</span>    <span class="c1">// char email[16];
</span>    <span class="c1">// char phone[10];
</span>    <span class="c1">// char cell[10];
</span>    <span class="c1">// char addr1[16];
</span>    <span class="c1">// char addr2[16];
</span>    <span class="c1">// char city[16];
</span>    <span class="c1">// char state[2];
</span>    <span class="c1">// char zip[5];
</span>    <span class="k">struct</span> <span class="n">__PHONE_BOOK_ENTRY</span> <span class="o">*</span><span class="n">pNext</span><span class="p">;</span>
<span class="p">}</span> <span class="n">entry</span><span class="p">;</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>Performance counter stats for './phonebook_opt' (100 runs):

           251,887      cache-misses              #   74.614 % of all cache refs      ( +-  0.13% )
           337,587      cache-references                                              ( +-  1.47% )
       242,971,052      instructions              #    1.81  insns per cycle          ( +-  0.02% )
       134,352,512      cycles                                                        ( +-  0.99% )

       0.052137429 seconds time elapsed                                               ( +-  1.03% )
</code></pre>
</div>

<p><img src="https://dl.dropboxusercontent.com/u/31201582/Blogger/2016-03-08-phonebook/comment_out_members.png" alt="Comment 後的 performance" /><br />
### 2. Hashing
—
採用<a href="http://www.partow.net/programming/hashfunctions/#BKDRHashFunction">BKDR hash</a>
&gt; This hash function comes from Brian Kernighan and Dennis Ritchie’s book “The C Programming Language”. It is a simple hash function using a strange set of possible seeds which all constitute a pattern of 31….31…31 etc, it seems to be very similar to the DJB hash function.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// BKDR Hash Function
</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">BKDRHash</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seed</span> <span class="o">=</span> <span class="mi">131</span><span class="p">;</span> <span class="c1">// 31 131 1313 13131 131313 etc..
</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">*</span> <span class="n">seed</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">hash</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFF</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>
<p>原來是來自Brian Kernighan and Dennis Ritchie’s的書，所以才較BKDR阿，是個易於記憶，效能也不錯的hash funciton。
修改成用bit operation，較為有效率</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">BKDRHash</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">hash</span> <span class="o">=</span> <span class="p">(</span><span class="n">hash</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">hash</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">hash</span> <span class="o">%</span> <span class="n">SIZE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p><img src="https://dl.dropboxusercontent.com/u/31201582/Blogger/2016-03-08-phonebook/hash_vi.png" alt="最終的效能比較圖" /></p>
